# Musubi Tuner への貢献

Musubi Tuner への貢献に関心をお持ちいただき、ありがとうございます！私たちはコミュニティからの貢献を歓迎し、このプロジェクトをさらに良くするために皆様と協力できることを楽しみにしています。

## 目次

- [はじめに](#はじめに)
- [貢献前に](#貢献前に)
- [貢献方法](#貢献方法)
  - [問題の報告](#問題の報告)
  - [機能の提案](#機能の提案)
  - [コードの貢献](#コードの貢献)
- [開発環境のセットアップ](#開発環境のセットアップ)
- [コードスタイルとガイドライン](#コードスタイルとガイドライン)
- [テスト](#テスト)
- [プルリクエストプロセス](#プルリクエストプロセス)
- [ライセンスと帰属](#ライセンスと帰属)
- [コミュニティとサポート](#コミュニティとサポート)

## はじめに

貢献前に以下をお願いします：

1. この貢献ガイドを読む
2. [README.md](README.md) でプロジェクトを理解する
3. [既存の Issue](https://github.com/kohya-ss/musubi-tuner/issues) と [ディスカッション](https://github.com/kohya-ss/musubi-tuner/discussions) を確認する
4. 開発環境をセットアップする

## 貢献前に

### 重要な注意事項

- このプロジェクトは限られたメンテナーリソースで活発に開発されています
- PRのレビューとマージには時間がかかる場合があります
- プロジェクトが発展する中で破壊的変更が発生する可能性があります
- 質問や一般的な議論には [GitHub Discussions](https://github.com/kohya-ss/musubi-tuner/discussions) を使用してください
- バグ報告や機能要求には [GitHub Issues](https://github.com/kohya-ss/musubi-tuner/issues) を使用してください

### 歓迎する貢献の種類

- バグ修正
- パフォーマンスの改善
- ドキュメントの改善
- 新機能（事前の議論を伴う）
- コード品質の改善

## 貢献方法

### 問題の報告

新しい Issue を作成する前に：

1. **既存の Issue を検索**して重複を避ける
2. **ディスカッションを確認**して、質問が既に回答されていないか確認する

バグ報告を作成する際は以下を含めてください：

- **明確で説明的なタイトル**
- **問題の詳細な説明**
- **問題を再現する手順**
- **環境の詳細**：
  - オペレーティングシステム
  - GPU モデルと VRAM
  - Python バージョン
  - PyTorch バージョン
  - CUDA バージョン
- **エラーメッセージやログ**
- **期待された動作と実際の動作**
- **スクリーンショットや動画**（該当する場合）

### 機能の提案

機能要求の場合：

1. **まず Issue を開いて**機能について議論する
2. **機能が解決する問題を説明**する
3. **提案された解決策を説明**する
4. **代替案とそのトレードオフ**を検討する
5. **実装前にフィードバックを待つ**

重要な機能については、まず [GitHub Discussions](https://github.com/kohya-ss/musubi-tuner/discussions) にコミュニティの意見を求めることを検討してください。

### コードの貢献

1. **Issue を開いて**提案する変更について議論する（些細な修正でない限り）
2. **重要な変更の作業を開始する前に承認を待つ**
3. **リポジトリをフォーク**して機能ブランチを作成する
4. **コードスタイルガイドライン**に従って変更を行う
5. **変更を徹底的にテスト**する
6. **プルリクエストを提出**する

## 開発環境のセットアップ

### 前提条件

- Python 3.10 以上
- Git
- CUDA 対応 GPU（GPU 機能のテスト用）
- 12GB 以上の VRAM 推奨

### インストール

1. **リポジトリをフォークしてクローン**：
   ```shell
   git clone https://github.com/your-username/musubi-tuner.git
   cd musubi-tuner
   ```

2. **開発環境をセットアップ**：

	**オプション B: uv を使用**
   ```shell
   # uv がない場合はインストール
   curl -LsSf https://astral.sh/uv/install.sh | sh  # Linux/Mac
   # または
   powershell -c "irm https://astral.sh/uv/install.ps1 | iex"  # Windows

   # 依存関係をインストール
   uv sync --extra cu128  # または CUDA バージョンに基づいて cu124
   ```

   **オプション A: pip を使用**
   ```shell
   # 仮想環境を作成
   python -m venv .venv

   # 仮想環境をアクティベート
   # Windows の場合:
	 .venv/Scripts/activate
   # Linux/Mac の場合:
	 source .venv/bin/activate

   # PyTorch をインストール（CUDA バージョンに合わせて調整）
   pip install torch torchvision --index-url https://download.pytorch.org/whl/cu128

   # パッケージを開発モードでインストール
   pip install -e .

   # 開発依存関係をインストール
   pip install --group dev
   ```

3. **Accelerate を設定**：
   ```shell
   accelerate config
   ```

## コードスタイルとガイドライン

### Python コードスタイル

このプロジェクトは **Ruff** をコードリンティングとコードフォーマッティングに使用しています：

- **行の長さ**: 132 文字
- **インデント**: 4 スペース
- **クォートスタイル**: ダブルクォート
- **対象 Python バージョン**: 3.9

### IDE

https://docs.astral.sh/ruff/editors/setup/

### コード品質ツールの実行

```shell
# コードスタイルと潜在的な問題をチェック
ruff check

# 可能な場合は自動修正
ruff check --fix

# コードをフォーマット（注: フォーマットには ruff を使用、black ではない）
ruff format src
```

### コードガイドライン

- **コードベースの既存パターン**に従う
- **明確で説明的な変数名**を書く
- **適切な場所で型ヒント**を追加する
- **関数を集中的で適度なサイズ**に保つ
- **パブリック関数とクラスにドキュメント文字列**を追加する
- **例外処理で優雅にエラーを処理**する

### インポートの整理

- 標準ライブラリのインポートを最初に
- サードパーティのインポートを次に
- ローカルインポートを最後に
- 可能な限り絶対インポートを使用

### アーキテクチャ固有のコード

アーキテクチャ固有のコード（HunyuanVideo、Wan2.1/2.2、FramePack、FLUX.1 Kontext、Qwen-Image）を扱う場合：

- **既存のインターフェースとの互換性を維持**する
- **既存のモジュール構造に従う**
- **`docs/` ディレクトリの関連ドキュメントを更新**する
- **変更が複数のシステムに影響する場合、能力があれば異なるアーキテクチャでテスト**する

## テスト

### テストの実行

```shell
# コード品質チェックを実行
ruff check

# コードをフォーマット
ruff format src

# 関連するスクリプトで変更を手動テスト
```

### 手動テストガイドライン

このプロジェクトは機械学習モデルを扱うため：

1. **まず小さなデータセット**でテストする
2. **メモリ使用量が期待する範囲内**であることを確認する
3. **可能であれば異なる GPU 構成**でテストする
4. **生成/訓練機能の出力品質**を検証する

## プルリクエストプロセス

### 提出前

1. **ブランチがメインブランチと最新**であることを確認する
2. **コード品質ツールを実行**：
   ```shell
   ruff check --fix
   ruff format src
   ```
3. **変更を徹底的にテスト**する
4. **必要に応じてドキュメントを更新**する
5. **明確なコミットメッセージ**を書く

### プルリクエストテンプレート

PR を作成する際は以下を含めてください：

- **変更を説明する明確なタイトル**
- **何が変更されたか、なぜかの説明**
- **Issue への参照**（例：「Closes #123」）
- **実行されたテスト**
- **破壊的変更**（ある場合）
- **ドキュメントの更新**（ある場合）

### レビュープロセス

- メンテナーは時間があるときに PR をレビューします
- 限られたリソースのためレビューに時間がかかる場合があります。辛抱強くお待ちください
- フィードバックに建設的に対処してください
- 議論を集中的かつ専門的に保ってください

## ライセンスと帰属

### 帰属要求

他のプロジェクトから派生または着想を得たコードを貢献する場合：

1. **新しいファイルに適切なライセンスヘッダー**を追加する
2. **コピー/修正されたコードに帰属コメント**を含める
3. **新しいライセンス要求を導入する場合は LICENSE ファイルを更新**する
4. **プルリクエストの説明でソースを文書化**する

### サードパーティコード

あなたの貢献にサードパーティコードが含まれる場合：

1. **プロジェクトとのライセンス互換性を確保**する
2. **元のライセンスファイルまたはヘッダーを含める**
3. **ソースとライセンスを明確に文書化**する
4. **ソースライセンスからのすべての義務を履行**する

## コミュニティとサポート

### コミュニケーションチャンネル

- **GitHub Discussions**: 一般的な質問、アイデア、コミュニティの交流
- **GitHub Issues**: バグ報告と機能要求
- **Pull Requests**: コード貢献とレビュー

### ヘルプの取得

以下についてヘルプが必要な場合：

- **ソフトウェアの使用**: [GitHub Discussions](https://github.com/kohya-ss/musubi-tuner/discussions) をチェックしてください
- **開発環境のセットアップ**: 「question」ラベルで Issue を作成してください
- **貢献プロセス**: このガイドを参照するか、ディスカッションで質問してください

### 認識

貢献者は以下を通じて認識されます：

- **Git コミット履歴**
- **重要な貢献のリリースノート**
- **主要な機能の README での謝辞**

---

## 最終注意事項

Musubi Tuner への貢献に関心をお持ちいただき、感謝いたします！このプロジェクトはコミュニティの貢献から大きな恩恵を受けており、皆様の時間と努力に感謝しています。

覚えておいてください：
- **最初の貢献は小さく**始めてください
- **何か不明な点があれば質問**してください
- **レビュープロセスに辛抱強く**お待ちください
- **素晴らしいツールの構築を楽しん**でください！

皆様がMusubi Tuner をより良くしてくださることに感謝いたします！